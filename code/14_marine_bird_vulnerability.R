#####################################################
### 14. Marine bird species vulnerability indexes ###
#####################################################

# Clear environment
rm(list = ls())

# Load packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,
               fasterize,
               fs,
               ggplot2,
               plyr,
               raster,
               rgdal,
               rgeos,
               rmapshaper,
               rnaturalearth, # use devtools::install_github("ropenscilabs/rnaturalearth") if packages does not install properly
               sf,
               sp,
               terra, # is replacing the raster package
               tidyr)

#####################################
#####################################

# Set directories
## Define data directory (as this is an R Project, pathnames are simplified)
### Input directories
data_dir <- "data/a_raw_data"
intermediate_dir <- "data/b_intermediate_data"

### Output directories
#### Marine bird species directory
dir.create(paste0(intermediate_dir, "/",
                  "marine_bird_species"))

marine_bird_species_dir <- "data/b_intermediate_data/marine_bird_species"

#####################################
#####################################

vulnerability_function <- function(pdf, pages){
  
  vulnerability_table <- tabulizer::extract_tables(pdf,
                                                   # page tables are found (235) -- Table 3
                                                   pages = pages,
                                                   output = "data.frame")[[1]] %>%
    # delete the first two rows as they do not contain relevant information
    dplyr::filter(!row_number() %in% c(1,2)) %>%
    
    # split out population vulnerability to be three columns for the lower, best estimate, and upper after the ")" at the end of the rank
    tidyr::separate(Population.Vulnerability, into=c("pop_lower", "pop_be", "pop_upper"), sep = "\\) ", remove = T, convert = T) %>%
    # split the best estimate for the population vulnerability by getting values before the ")" designating rank
    tidyr::separate(pop_be, into=c("pop_be_value", "pop_be_rank"), sep = " \\(", remove = T, convert = T) %>%
    
    # split out collision vulnerability to be three columns for the lower, best estimate, and upper after the ")" at the end of the rank
    tidyr::separate(Collision.Vulnerability, into=c("col_lower", "col_be"), sep = "\\) ", remove = T, convert = T) %>%
    # split the best estimate for the collision vulnerability by getting values before the ")" designating rank
    tidyr::separate(col_be, into=c("col_be_value", "col_be_rank"), sep = " \\(", remove = T, convert = T) %>%
    
    # split out displacement vulnerability to be three columns for the lower, best estimate, and upper after the ")" at the end of the rank
    tidyr::separate(Displacement.Vulnerability, into=c("dis_lower", "dis_be", "dis_upper"), sep = "\\) ", remove=T, convert = T) %>%
    # split the best estimate for the displacement vulnerability by getting values before the ")" designating rank
    tidyr::separate(dis_be, into=c("dis_be_value", "dis_be_rank"), sep = " \\(", remove = T, convert = T) %>%
    
    # select 
    dplyr::select(Alpha.code,
                  pop_be_value,
                  col_be_value,
                  dis_be_value) %>%
    dplyr::rename(species_code = Alpha.code) %>%
    # remove any rows with NA values
    na.omit()
  
  return(vulnerability_table)
}

#####################################
#####################################

# load data
### Kelsey et al. (2018) (source: https://www.sciencedirect.com/science/article/abs/pii/S0301479718309228)
pdf <- paste(data_dir, "kelsey_etal_2018.pdf", sep = "/")

#####################################
#####################################

# Create vulnerability tables
## First part of Table 3 (page 7, or page 235 of Kelsey et al. 2018)
vulnerability_table1 <- vulnerability_function(pdf, 7)

## Second part of Table 3 (page 8, or page 236 of Kelsey et al. 2018)
vulnerability_table2 <- vulnerability_function(pdf, 8)

## Create full vulnerability tables
vulnerability_table <- vulnerability_table1 %>%
  rbind(vulnerability_table2)

#####################################
#####################################

# Export data
## Marine bird species directory
saveRDS(obj = vulnerability_table, file = paste(marine_bird_species_dir, "marine_bird_species_vulnerability.rds", sep = "/"))
