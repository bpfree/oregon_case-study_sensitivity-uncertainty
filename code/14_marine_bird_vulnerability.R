#####################################################
### 14. Marine bird species vulnerability indexes ###
#####################################################

# Clear environment
rm(list = ls())

# Load packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,
               fasterize,
               fs,
               ggplot2,
               plyr,
               raster,
               rgdal,
               rgeos,
               rmapshaper,
               rnaturalearth, # use devtools::install_github("ropenscilabs/rnaturalearth") if packages does not install properly
               sf,
               sp,
               terra, # is replacing the raster package
               tidyr)

#####################################
#####################################

# Set directories
## Define data directory (as this is an R Project, pathnames are simplified)
### Input directories
data_dir <- "data/a_raw_data"
intermediate_dir <- "data/b_intermediate_data"

### Output directories
#### Marine bird species directory
dir.create(paste0(intermediate_dir, "/",
                  "marine_bird_species"))

marine_bird_species_dir <- "data/b_intermediate_data/marine_bird_species"

#####################################
#####################################

vulnerability_function <- function(pdf, pages){
  
  # create vulnerability table from PDF
  vulnerability_table <- tabulizer::extract_tables(pdf,
                                                   # page tables are found (235) -- Table 3
                                                   pages = pages,
                                                   output = "data.frame")[[1]] %>%
    # delete the first two rows as they do not contain relevant information
    dplyr::filter(!row_number() %in% c(1,2)) %>%
    
    # split out population vulnerability to be three columns for the lower, best estimate, and upper after the ")" at the end of the rank
    tidyr::separate(Population.Vulnerability, into = c("pop_lower", "pop_be", "pop_upper"), sep = "\\) ", remove = T, convert = T) %>%
    # split the best estimate for the population vulnerability by getting values before the ")" designating rank
    tidyr::separate(pop_lower, into = c("pop_lower_value", "pop_lower_rank"), sep = " \\(", remove = T, convert = T) %>%
    # split the best estimate for the population vulnerability by getting values before the ")" designating rank
    tidyr::separate(pop_be, into = c("pop_be_value", "pop_be_rank"), sep = " \\(", remove = T, convert = T) %>%
    # split the best estimate for the population vulnerability by getting values before the ")" designating rank
    tidyr::separate(pop_upper, into = c("pop_upper_value", "pop_upper_rank"), sep = " \\(", remove = T, convert = T) %>%
    
    # split out collision vulnerability to be three columns for the lower, best estimate, and upper after the ")" at the end of the rank
    tidyr::separate(Collision.Vulnerability, into = c("col_lower", "col_be"), sep = "\\) ", remove = T, convert = T) %>%
    # split the lower for the collision vulnerability by getting values before the ")" designating rank
    tidyr::separate(col_lower, into = c("col_lower_value", "col_lower_rank"), sep = " \\(", remove = T, convert = T) %>%
    # split the best estimate for the collision vulnerability by getting values before the ")" designating rank
    tidyr::separate(col_be, into = c("col_be_value", "col_be_rank"), sep = " \\(", remove = T, convert = T) %>%
    # split the lower for the collision vulnerability by getting values before the ")" designating rank
    tidyr::separate(X.1, into = c("col_upper_value", "col_upper_rank"), sep = " \\(", remove = T, convert = T) %>%
    
    # split out displacement vulnerability to be three columns for the lower, best estimate, and upper after the ")" at the end of the rank
    tidyr::separate(Displacement.Vulnerability, into = c("dis_lower", "dis_be", "dis_upper"), sep = "\\) ", remove=T, convert = T) %>%
    # split the lower for the displacement vulnerability by getting values before the ")" designating rank
    tidyr::separate(dis_lower, into = c("dis_lower_value", "dis_lower_rank"), sep = " \\(", remove = T, convert = T) %>%
    # split the best estimate for the displacement vulnerability by getting values before the ")" designating rank
    tidyr::separate(dis_be, into = c("dis_be_value", "dis_be_rank"), sep = " \\(", remove = T, convert = T) %>%
    # split the upper for the displacement vulnerability by getting values before the ")" designating rank
    tidyr::separate(dis_upper, into = c("dis_upper_value", "dis_upper_rank"), sep = " \\(", remove = T, convert = T) %>%
    
    # rename fields to designate their association with vulnerability rank position
    dplyr::rename(pop_rank = X,
                  col_rank = X.2,
                  dis_rank = X.3) %>%
    
    # select and order fields
    dplyr::select(Alpha.code,
                  Species,
                  pop_lower_value,
                  pop_be_value,
                  pop_upper_value,
                  pop_rank,
                  col_lower_value,
                  col_be_value,
                  col_upper_value,
                  col_rank,
                  dis_lower_value,
                  dis_be_value,
                  dis_upper_value,
                  dis_rank) %>%
    
    # rename the alpha code to designate it as a code for species
    dplyr::rename(species_code = Alpha.code,
                  species_name = Species) %>%
    
    # remove any rows with NA values
    na.omit()
  
  return(vulnerability_table)
}

#####################################

population_vulnerability_function <- function(pdf, pages){
  
  pop_vulnerability_table <- tabulizer::extract_tables(pdf,
                                                   # page tables are found (241 - 243) -- Appendix Table 2
                                                   pages = pages,
                                                   output = "data.frame")[[1]] %>%
    
    # delete the first two rows as they do not contain relevant information
    dplyr::filter(!row_number() %in% c(1)) %>%
    
    # spearate population vulnerability into lower, best estimate, and upper values
    tidyr::separate(Population.Vulnerability, into = c("pop_lower_value", "pop_be_value", "pop_upper_value"), sep = " ", remove = T, convert = T) %>%
    
    # rename fields
    dplyr::rename(species_name = Species.name..English.,
                  # uncertainty for global population (POP)
                  pop_uncertain = u,
                  # uncertainty for percent of population in the Pacific Outer Continental Shelf (POCSpop)
                  pocs_pop_uncertain = u.1,
                  # uncertainty for adult survival (AS)
                  as_uncertain = u.2,
                  # percent of best value
                  percent = X)
  
  return(pop_vulnerability_table)
}

#####################################

displacement_vulnerability_function <- function(pdf, pages){
  
  dis_vulnerability_table <- tabulizer::extract_tables(pdf,
                                                       # page tables are found (245 - 246) -- Appendix Table 4
                                                       pages = pages,
                                                       output = "data.frame")[[1]] %>%
    
    # delete the first two rows as they do not contain relevant information
    dplyr::filter(!row_number() %in% c(1)) %>%
    
    # spearate population vulnerability into lower, best estimate, and upper values
    tidyr::separate(Displacement.Vulnerability, into = c("dis_lower_value", "dis_be_value"), sep = " ", remove = T, convert = T) %>%
    
    # rename fields
    dplyr::rename(species_name = Species.name..English.,
                  # uncertainty for macro-avoidance (MAd)
                  mad_uncertain = u,
                  # uncertainty for habitat flexibility (HF)
                  hf_uncertain = u.1,
                  # displacement upper value
                  dis_upper_value = X,
                  # percent of best value
                  be_percent = X.1)
  
  return(dis_vulnerability_table)
}

#####################################
#####################################

# load data
### Kelsey et al. (2018) (source: https://www.sciencedirect.com/science/article/abs/pii/S0301479718309228)
pdf <- paste(data_dir, "kelsey_etal_2018.pdf", sep = "/")

#####################################
#####################################

# Create vulnerability tables
## First part of Table 3 (page 7, or page 235 of Kelsey et al. 2018)
vulnerability_table1 <- vulnerability_function(pdf, 7) %>%
  # recode species names for ones that are spread across two rows
  dplyr::mutate(species_name = recode(species_name,
                                      "Red-breasted" = "Red-breasted Merganser",
                                      "White-winged" = "White-winged Scoter",
                                      "Black-footed" = "Black-footed Albatross",
                                      "Pink-footed" = "Pink-footed Shearwater",
                                      "Flesh-footed" = "Flesh-footed Shearwater",
                                      "Black-vented" = "Black-vented Shearwater",
                                      "Wilson's Storm-" = "Wilson's Storm-Petrel",
                                      "Fork-tailed Storm-" = "Fork-tailed Storm-Petrel",
                                      "Double-crested" = "Double-crested Cormorant",
                                      "American White" = "American White Pelican",
                                      "Red-necked" = "Red-necked Phalarope")) %>%
  # change contents for two cells that have the same start of the common name
  ## see short-tailed Albatross (STAL) and short-tailed shearwater (SRTS)
  dplyr::mutate(species_name = ifelse(species_code == "STAL", "Short-tailed Albatross", species_name)) %>%
  dplyr::mutate(species_name = ifelse(species_code == "SRTS", "Short-tailed Shearwater", species_name)) %>%
  #

## Second part of Table 3 (page 8, or page 236 of Kelsey et al. 2018)
vulnerability_table2 <- vulnerability_function(pdf, 8) %>%
  # recode species names for ones that are spread across two rows
  dplyr::mutate(species_name = recode(species_name,
                                      "Black-legged" = "Black-legged Kittiwake",
                                      "Glaucous-winged" = "Glaucous-winged Gull"))

## Create full vulnerability tables
vulnerability_table <- vulnerability_table1 %>%
  rbind(vulnerability_table2)

#####################################

# Create vulnerability metric tables
## Population vulnerability table
population_vulnerability_table <- population_vulnerability_function(pdf, 13) %>%
  rbind(population_vulnerability_function(pdf, 14),
        population_vulnerability_function(pdf, 15)) %>%
  dplyr::left_join(x = .,
                   y = vulnerability_table,
                   by = "species_name") %>%
  dplyr::select(-pop_lower_value.y,
                -pop_be_value.y,
                -pop_upper_value.y,
                -col_lower_value,
                -col_be_value,
                -col_upper_value,
                -col_rank,
                -dis_lower_value,
                -dis_be_value,
                -dis_upper_value,
                -dis_rank) %>%
  dplyr::rename(dis_lower_value = pop_lower_value.x,
                dis_be_value = pop_be_value.x,
                dis_upper_value = pop_upper_value.x) %>%
  dplyr::relocate(species_code, .before = species_name)

#####################################

## Collision vulnerability table
### First part of Appendix Table 3 (page 15, or page 243 of Kelsey et al. 2018)
col_vulnerability_table1 <- tabulizer::extract_tables(pdf,
                                                      # page tables are found (243 - 244) -- Appendix Table 3
                                                      pages = 15,
                                                      # it is the 2nd table on the 15th page
                                                      output = "data.frame")[[2]] %>%
  
  # delete the first two rows as they do not contain relevant information
  dplyr::filter(!row_number() %in% c(1)) %>%
  
  # spearate population vulnerability into lower, best estimate, and upper values
  tidyr::separate(Average.Flight.Activity, into = c("avg_flgt_act_lower_value", "avg_flgt_act_be_value", "avg_flgt_act_upper_value"), sep = " ", remove = T, convert = T) %>%
  tidyr::separate(Collision.Vulnerability, into = c("col_lower_value", "col_be_value", "col_upper_value"), sep = " ", remove = T, convert = T) %>%
  
  # ***Note: see methods from Kelsey et al. (2018) to see more detail on average flight activity (average of nocturnal flight activity (NFA) and diurnal flight activity (DFA))
  
  # rename fields
  dplyr::rename(species_name = Species.name,
                # uncertainty for percent time spent in rotor sweep zone
                rszt_uncertain = u,
                # uncertainty for macro-avoidance
                mac_uncertain = u.1,
                # percent of best values
                percent = X)

### Second part of Appendix Table 3 (page 16, or page 243 of Kelsey et al. 2018)
col_vulnerability_table2 <- tabulizer::extract_tables(pdf,
                                                      # page tables are found (243 - 244) -- Appendix Table 3
                                                      pages = 16,
                                                      # it is the 1st table on the 16th page
                                                      output = "data.frame")[[1]] %>%
  
  # delete the first two rows as they do not contain relevant information
  dplyr::filter(!row_number() %in% c(1)) %>%
  
  # spearate population vulnerability into lower, best estimate, and upper values
  tidyr::separate(Average.Flight.Activity, into = c("avg_flgt_act_lower_value", "avg_flgt_act_be_value", "avg_flgt_act_upper_value"), sep = " ", remove = T, convert = T) %>%
  tidyr::separate(Collision.Vulnerability, into = c("col_lower_value", "col_be_value", "col_upper_value"), sep = " ", remove = T, convert = T) %>%
  
  # ***Note: see methods from Kelsey et al. (2018) to see more detail on average flight activity (average of nocturnal flight activity (NFA) and diurnal flight activity (DFA))
  
  # rename fields
  dplyr::rename(species_name = Species.name,
                # uncertainty for percent time spent in rotor sweep zone
                rszt_uncertain = u,
                # uncertainty for macro-avoidance
                mac_uncertain = u.1,
                # percent of best values
                percent = X)

collision_vulnerability_table <- col_vulnerability_table1 %>%
  rbind(col_vulnerability_table2) %>%
  dplyr::left_join(x = .,
                   y = vulnerability_table,
                   by = "species_name") %>%
  dplyr::select(-pop_lower_value,
                -pop_be_value,
                -pop_upper_value,
                -pop_rank,
                -col_lower_value.y,
                -col_be_value.y,
                -col_upper_value.y,
                -dis_lower_value,
                -dis_be_value,
                -dis_upper_value,
                -dis_rank) %>%
  dplyr::rename(col_lower_value = col_lower_value.x,
                col_be_value = col_be_value.x,
                col_upper_value = col_upper_value.x) %>%
  dplyr::relocate(species_code, .before = species_name)

#####################################

## Displacement vulnerability table
displacement_vulnerability_table <- displacement_vulnerability_function(pdf, 17) %>%
  rbind(displacement_vulnerability_function(pdf, 18)) %>%
  dplyr::left_join(x = .,
                   y = vulnerability_table,
                   by = "species_name") %>%
  dplyr::select(-pop_lower_value,
                -pop_be_value,
                -pop_upper_value,
                -pop_rank,
                -col_lower_value,
                -col_be_value,
                -col_upper_value,
                -col_rank,
                -dis_lower_value.y,
                -dis_be_value.y,
                -dis_upper_value.y) %>%
  dplyr::rename(dis_lower_value = dis_lower_value.x,
                dis_be_value = dis_be_value.x,
                dis_upper_value = dis_upper_value.x) %>%
  dplyr::relocate(species_code, .before = species_name)

#####################################
#####################################

# Export data
## Marine bird species directory
### Overall vulnerability table
saveRDS(obj = vulnerability_table, file = paste(marine_bird_species_dir, "marine_bird_species_vulnerability.rds", sep = "/"))

### Metric specific vulnerability table
saveRDS(obj = population_vulnerability_table, file = paste(marine_bird_species_dir, "marine_bird_species_population_vulnerability.rds", sep = "/"))
saveRDS(obj = collision_vulnerability_table, file = paste(marine_bird_species_dir, "marine_bird_species_collision_vulnerability.rds", sep = "/"))
saveRDS(obj = displacement_vulnerability_table, file = paste(marine_bird_species_dir, "marine_bird_species_displacement_vulnerability.rds", sep = "/"))
