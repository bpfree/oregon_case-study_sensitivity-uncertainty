#####################################################
### 14. Marine Bird Species Vulnerability Indices ###
#####################################################

# Clear environment
rm(list = ls())

# Load packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,
               fasterize,
               fs,
               ggplot2,
               plyr,
               raster,
               rgdal,
               rgeos,
               rmapshaper,
               rnaturalearth, # use devtools::install_github("ropenscilabs/rnaturalearth") if packages does not install properly
               sf,
               sp,
               terra, # is replacing the raster package
               tidyr)

#####################################
#####################################

# Set directories
## Define data directory (as this is an R Project, pathnames are simplified)
### Input directories
data_dir <- "data/a_raw_data"
intermediate_dir <- "data/b_intermediate_data"

pop_dir <- "data/a_raw_data/Populationvulne"
col_dir <- "data/a_raw_data/Collisionvulner"
dis_dir <- "data/a_raw_data/Displacementvul"

### Output directories
#### Marine bird species directory
dir.create(paste0(intermediate_dir, "/",
                  "marine_bird_species"))

marine_bird_species_dir <- "data/b_intermediate_data/marine_bird_species"

#####################################
#####################################

vulnerability_function <- function(pdf, pages){
  
  # create vulnerability table from PDF
  vulnerability_table <- tabulizer::extract_tables(pdf,
                                                   # page tables are found (235) -- Table 3
                                                   pages = pages,
                                                   output = "data.frame")[[1]] %>%
    # delete the first two rows as they do not contain relevant information
    dplyr::filter(!row_number() %in% c(1,2)) %>%
    
    # split out population vulnerability to be three columns for the lower, best estimate, and upper after the ")" at the end of the rank
    tidyr::separate(Population.Vulnerability, into = c("pv_lower", "pv_be", "pv_upper"), sep = "\\) ", remove = T, convert = T) %>%
    # split the best estimate for the population vulnerability by getting values before the ")" designating rank
    tidyr::separate(pv_lower, into = c("pv_lower_value", "pv_lower_rank"), sep = " \\(", remove = T, convert = T) %>%
    # split the best estimate for the population vulnerability by getting values before the ")" designating rank
    tidyr::separate(pv_be, into = c("pv_be_value", "pv_be_rank"), sep = " \\(", remove = T, convert = T) %>%
    # split the best estimate for the population vulnerability by getting values before the ")" designating rank
    tidyr::separate(pv_upper, into = c("pv_upper_value", "pv_upper_rank"), sep = " \\(", remove = T, convert = T) %>%
    
    # split out collision vulnerability to be three columns for the lower, best estimate, and upper after the ")" at the end of the rank
    tidyr::separate(Collision.Vulnerability, into = c("cv_lower", "cv_be"), sep = "\\) ", remove = T, convert = T) %>%
    # split the lower for the collision vulnerability by getting values before the ")" designating rank
    tidyr::separate(cv_lower, into = c("cv_lower_value", "cv_lower_rank"), sep = " \\(", remove = T, convert = T) %>%
    # split the best estimate for the collision vulnerability by getting values before the ")" designating rank
    tidyr::separate(cv_be, into = c("cv_be_value", "cv_be_rank"), sep = " \\(", remove = T, convert = T) %>%
    # split the lower for the collision vulnerability by getting values before the ")" designating rank
    tidyr::separate(X.1, into = c("cv_upper_value", "cv_upper_rank"), sep = " \\(", remove = T, convert = T) %>%
    
    # split out displacement vulnerability to be three columns for the lower, best estimate, and upper after the ")" at the end of the rank
    tidyr::separate(Displacement.Vulnerability, into = c("dv_lower", "dv_be", "dv_upper"), sep = "\\) ", remove=T, convert = T) %>%
    # split the lower for the displacement vulnerability by getting values before the ")" designating rank
    tidyr::separate(dv_lower, into = c("dv_lower_value", "dv_lower_rank"), sep = " \\(", remove = T, convert = T) %>%
    # split the best estimate for the displacement vulnerability by getting values before the ")" designating rank
    tidyr::separate(dv_be, into = c("dv_be_value", "dv_be_rank"), sep = " \\(", remove = T, convert = T) %>%
    # split the upper for the displacement vulnerability by getting values before the ")" designating rank
    tidyr::separate(dv_upper, into = c("dv_upper_value", "dv_upper_rank"), sep = " \\(", remove = T, convert = T) %>%
    
    # rename fields to designate their association with vulnerability rank position
    dplyr::rename(pv_rank = X,
                  cv_rank = X.2,
                  dv_rank = X.3) %>%
    
    # select and order fields
    dplyr::select(Alpha.code,
                  Species,
                  pv_lower_value,
                  pv_be_value,
                  pv_upper_value,
                  pv_rank,
                  cv_lower_value,
                  cv_be_value,
                  cv_upper_value,
                  cv_rank,
                  dv_lower_value,
                  dv_be_value,
                  dv_upper_value,
                  dv_rank) %>%
    
    # rename the alpha code to designate it as a code for species
    dplyr::rename(species_code = Alpha.code,
                  species_name = Species) %>%
    
    # remove any rows with NA values
    na.omit()
  
  return(vulnerability_table)
}

#####################################

population_vulnerability_function <- function(pdf, pages){
  
  pop_vulnerability_table <- tabulizer::extract_tables(pdf,
                                                   # page tables are found (241 - 243) -- Appendix Table 2
                                                   pages = pages,
                                                   output = "data.frame")[[1]] %>%
    
    # delete the first two rows as they do not contain relevant information
    dplyr::filter(!row_number() %in% c(1)) %>%
    
    # spearate population vulnerability into lower, best estimate, and upper values
    tidyr::separate(Population.Vulnerability, into = c("pv_lower_value", "pv_be_value", "pv_upper_value"), sep = " ", remove = T, convert = T) %>%
    
    # rename fields
    dplyr::rename(species_name = Species.name..English.,
                  # uncertainty for global population (POP)
                  pop_uncertain = u,
                  # uncertainty for percent of population in the Pacific Outer Continental Shelf (POCSpop)
                  pocs_pop_uncertain = u.1,
                  # uncertainty for adult survival (AS)
                  as_uncertain = u.2,
                  # percent of best value
                  percent = X)
  
  return(pop_vulnerability_table)
}

#####################################

displacement_vulnerability_function <- function(pdf, pages){
  
  dis_vulnerability_table <- tabulizer::extract_tables(pdf,
                                                       # page tables are found (245 - 246) -- Appendix Table 4
                                                       pages = pages,
                                                       output = "data.frame")[[1]] %>%
    
    # delete the first two rows as they do not contain relevant information
    dplyr::filter(!row_number() %in% c(1)) %>%
    
    # spearate population vulnerability into lower, best estimate, and upper values
    tidyr::separate(Displacement.Vulnerability, into = c("dv_lower_value", "dv_be_value"), sep = " ", remove = T, convert = T) %>%
    
    # rename fields
    dplyr::rename(species_name = Species.name..English.,
                  # uncertainty for macro-avoidance (MAd)
                  mad_uncertain = u,
                  # uncertainty for habitat flexibility (HF)
                  hf_uncertain = u.1,
                  # displacement upper value
                  dis_upper_value = X,
                  # percent of best value
                  be_percent = X.1)
  
  return(dis_vulnerability_table)
}

#####################################
#####################################

# load data
## Marine bird densities
marine_bird_dir <- "data/a_raw_data/marine_bird/0242882/1.1/data/0-data/model_output_predictions/"

## Kelsey et al. (2018) (source: https://www.sciencedirect.com/science/article/abs/pii/S0301479718309228)
pdf <- paste(data_dir, "kelsey_etal_2018.pdf", sep = "/")

#####################################
#####################################

# get list of all species and season combinations
species_season_files <- list.files(marine_bird_dir,
                                   pattern = "_density.tif")

# return only unique species codes
## return first element after splitting file names at each "_" and apply that across all the files in the directory
species_list <- unique(sapply(strsplit(species_season_files, "_"), function(x) x[1]))

#####################################
#####################################

# Create vulnerability tables
## Kelsey et al. (2018)
### First part of Table 3 (page 7, or page 235 of Kelsey et al. 2018)
vulnerability_table1 <- vulnerability_function(pdf, 7) %>%
  # recode species names for ones that are spread across two rows
  dplyr::mutate(species_name = recode(species_name,
                                      "Red-breasted" = "Red-breasted Merganser",
                                      "White-winged" = "White-winged Scoter",
                                      "Black-footed" = "Black-footed Albatross",
                                      "Pink-footed" = "Pink-footed Shearwater",
                                      "Flesh-footed" = "Flesh-footed Shearwater",
                                      "Black-vented" = "Black-vented Shearwater",
                                      "Wilson's Storm-" = "Wilson's Storm-Petrel",
                                      "Fork-tailed Storm-" = "Fork-tailed Storm-Petrel",
                                      "Double-crested" = "Double-crested Cormorant",
                                      "American White" = "American White Pelican",
                                      "Red-necked" = "Red-necked Phalarope")) %>%
  # change contents for two cells that have the same start of the common name
  ## see short-tailed Albatross (STAL) and short-tailed shearwater (SRTS)
  dplyr::mutate(species_name = ifelse(species_code == "STAL", "Short-tailed Albatross", species_name)) %>%
  dplyr::mutate(species_name = ifelse(species_code == "SRTS", "Short-tailed Shearwater", species_name))

### Second part of Table 3 (page 8, or page 236 of Kelsey et al. 2018)
vulnerability_table2 <- vulnerability_function(pdf, 8) %>%
  # recode species names for ones that are spread across two rows
  dplyr::mutate(species_name = recode(species_name,
                                      "Black-legged" = "Black-legged Kittiwake",
                                      "Glaucous-winged" = "Glaucous-winged Gull"))

### Create full vulnerability tables
vulnerability_table <- vulnerability_table1 %>%
  rbind(vulnerability_table2)

marine_bird_vulnerabilities <- vulnerability_table %>%
  dplyr::select(species_code, species_name,
                pv_be_value,
                cv_be_value,
                dv_be_value)

#####################################
#####################################

# species not individually modeled by Leirness et al. (2021)
species_not_modeled <- marine_bird_vulnerabilities %>%
  dplyr::filter(!species_code %in% species_list)

# get species codes that are part of taxonomic groups
species_lacking_vulnerabilities <- species_list[!(species_list %in% marine_bird_vulnerabilities$species_code)]

# taxonomic groups
## create data frame that matches species table from Kelsey et al. (2017) and populate with taxonomic groups
taxonomic_group <- data.frame(species_code = species_list[!(species_list %in% marine_bird_vulnerabilities$species_code)],
                              species_name = NA,
                              pv_be_value = NA, cv_be_value = NA, dv_be_value = NA)

#####################################

# Taxonomic group vulnerability values
taxonomic_group <- taxonomic_group %>%
  # add taxonomic group name based on species code
  dplyr::mutate(species_name = case_when(species_code == "SCOT" ~ "Scoter spp.",
                                         species_code == "WEGR-CLGR" ~ "Western/Clark's Grebe",
                                         species_code == "PHAL" ~ "Phalarope spp.",
                                         species_code == "PAJA-LTJA" ~ "Parasitic/Long-tailed Jaeger",
                                         species_code == "JAEG" ~ "Jaeger spp.",
                                         species_code == "SCMU-GUMU-CRMU" ~ "Scripps's/Guadalupe/Craveri's Murrelet",
                                         species_code == "WEGU-WGWH-GWGU" ~ "Western/Glaucous-winged Gull",
                                         species_code == "HERG-ICGU" ~ "Herring/Iceland Gull",
                                         species_code == "COTE-ARTE" ~ "Common/Artic Tern",
                                         species_code == "ROYT-ELTE" ~ "Royal/Elegant Tern",
                                         species_code == "LOON" ~ "Loon spp.",
                                         species_code == "STTS-SOSH-FFSH" ~ "Short-tailed/Sooty/Flesh-footed Shearwater",
                                         species_code == "CORM" ~ "Cormorant spp.")) %>%
  
  # calculate vulnerability for taxonomic group
  ## take the maximum value from species within taxonomic groups
  ### population volunerabilities
  dplyr::mutate(pv_be_value = case_when(species_code == "SCOT" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("BLSC", "SUSC", "WWSC"), "pv_be_value"]),
                                        species_code == "WEGR-CLGR" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("WEGR", "CLGR"), "pv_be_value"]),
                                        species_code == "PHAL" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("WIPH", "RNPH", "REPH"), "pv_be_value"]),
                                        species_code == "PAJA-LTJA" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("PAJA", "LTJA"), "pv_be_value"]),
                                        species_code == "JAEG" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("POJA", "PAJA", "LTJA"), "pv_be_value"]),
                                        species_code == "SCMU-GUMU-CRMU" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("SCMU", "GUMU", "CRMU"), "pv_be_value"]),
                                        species_code == "WEGU-WGWH-GWGU" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("WEGU", "WGWH", "GWGU"), "pv_be_value"]),
                                        species_code == "HERG-ICGU" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("HERG", "ICGU", "THGU"), "pv_be_value"]),
                                        species_code == "COTE-ARTE" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("COTE", "ARTE"), "pv_be_value"]),
                                        species_code == "ROYT-ELTE" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("ROYT", "ELTE"), "pv_be_value"]),
                                        species_code == "LOON" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("RTLO", "PALO", "COLO", "YBLO"), "pv_be_value"]),
                                        species_code == "STTS-SOSH-FFSH" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("STTS", "SRTS", "SOSH", "FFSH"), "pv_be_value"]),
                                        species_code == "CORM" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("BRAC", "PECO", "DCCO"), "pv_be_value"])),
                
                # collision vulnerabilities
                cv_be_value = case_when(species_code == "SCOT" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("BLSC", "SUSC", "WWSC"), "cv_be_value"]),
                                        species_code == "WEGR-CLGR" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("WEGR", "CLGR"), "cv_be_value"]),
                                        species_code == "PHAL" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("WIPH", "RNPH", "REPH"), "cv_be_value"]),
                                        species_code == "PAJA-LTJA" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("PAJA", "LTJA"), "cv_be_value"]),
                                        species_code == "JAEG" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("POJA", "PAJA", "LTJA"), "cv_be_value"]),
                                        species_code == "SCMU-GUMU-CRMU" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("SCMU", "GUMU", "CRMU"), "cv_be_value"]),
                                        species_code == "WEGU-WGWH-GWGU" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("WEGU", "WGWH", "GWGU"), "cv_be_value"]),
                                        species_code == "HERG-ICGU" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("HERG", "ICGU", "THGU"), "cv_be_value"]),
                                        species_code == "COTE-ARTE" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("COTE", "ARTE"), "cv_be_value"]),
                                        species_code == "ROYT-ELTE" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("ROYT", "ELTE"), "cv_be_value"]),
                                        species_code == "LOON" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("RTLO", "PALO", "COLO", "YBLO"), "cv_be_value"]),
                                        species_code == "STTS-SOSH-FFSH" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("STTS", "SRTS", "SOSH", "FFSH"), "cv_be_value"]),
                                        species_code == "CORM" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("BRAC", "PECO", "DCCO"), "cv_be_value"])),
                
                # displacement vulnerabilities
                dv_be_value = case_when(species_code == "SCOT" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("BLSC", "SUSC", "WWSC"), "dv_be_value"]),
                                        species_code == "WEGR-CLGR" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("WEGR", "CLGR"), "dv_be_value"]),
                                        species_code == "PHAL" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("WIPH", "RNPH", "REPH"), "dv_be_value"]),
                                        species_code == "PAJA-LTJA" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("PAJA", "LTJA"), "dv_be_value"]),
                                        species_code == "JAEG" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("POJA", "PAJA", "LTJA"), "dv_be_value"]),
                                        species_code == "SCMU-GUMU-CRMU" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("SCMU", "GUMU", "CRMU"), "dv_be_value"]),
                                        species_code == "WEGU-WGWH-GWGU" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("WEGU", "WGWH", "GWGU"), "dv_be_value"]),
                                        species_code == "HERG-ICGU" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("HERG", "ICGU", "THGU"), "dv_be_value"]),
                                        species_code == "COTE-ARTE" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("COTE", "ARTE"), "dv_be_value"]),
                                        species_code == "ROYT-ELTE" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("ROYT", "ELTE"), "dv_be_value"]),
                                        species_code == "LOON" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("RTLO", "PALO", "COLO", "YBLO"), "dv_be_value"]),
                                        species_code == "STTS-SOSH-FFSH" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("STTS", "SRTS", "SOSH", "FFSH"), "dv_be_value"]),
                                        species_code == "CORM" ~ max(marine_bird_vulnerabilities[marine_bird_vulnerabilities$species_code %in% c("BRAC", "PECO", "DCCO"), "dv_be_value"])))


species_taxonomic_table <- rbind(marine_bird_vulnerabilities,
                                 taxonomic_group)

#####################################
#####################################

vul_norm_function <- function(table){
  # Create values for maximums and minimums for vulnerability indices
  ## These values are used to normalize across species and have all values between 0 and 1
  
  ## Population vulnerability
  ### Equation (Kelsey et al. 2018): POP + AO * POCSpop + TS + BR x AS
  ### POP, POCSpop, TS, AS have minimums of 1 and maximum of 5; AO and BR have minimums of 1 and maximums of 2
  pop_max <- 30 # 5 + 2 * 5 + 5 + 2 * 5
  pop_min <- 4  # 1 + 1 * 1 + 1 + 1 * 1
  
  ## Collision vulnerability
  ### Equation (Kelsey et al. 2018): ((NFA + DFA) / 2) + RSZt + MAc
  ### NFA, DFA, RSZt, MAc have minimums of 1 and maximums of 5
  ### ***Note: this equation is different from Adams et al. 2017
  col_max <- 15 # ((5 + 5) / 2) + 5 + 5
  col_min <- 3  # (1 + 1) / 2) + 1 + 1
  
  ## Displacement vulnerability
  ### Equation (Kelsey et al. 2018): MAd + HF
  ### MAd, HF have minimums of 1 and maximums of 5
  dis_max <- 10 # 5 + 5
  dis_min <- 2  # 1 + 1
  
  species_vulnerabilities <- table %>%
    # normalize vulnerability indices ((value - index minimum) / (index maximum - index minimum))
    dplyr::mutate(pv_norm = (pv_be_value - pop_min) / (pop_max - pop_min), # population vulnerability index normalization
                  # collision vulnerability index normalization
                  cv_norm = (cv_be_value - col_min) / (col_max - col_min),
                  # displacement vulnerability index normalization
                  dv_norm = (dv_be_value - dis_min) / (dis_max - dis_min)) %>%
    # calculate overall vulnerability (population vulnerability * maximum value between collision and displacement vulnerabilities)
    dplyr::mutate(overall_vul = pv_norm * pmax(cv_norm, dv_norm)) %>%
    # select all the key fields
    dplyr::select(species_code, species_name,
                  pv_be_value, cv_be_value, dv_be_value,
                  pv_norm, cv_norm, dv_norm,
                  overall_vul)
  
  return(species_vulnerabilities)
}

species_vulnerabilities_normalized <- vul_norm_function(species_taxonomic_table)

#####################################
#####################################

# Export data
## Marine bird species directory
### Overall vulnerability table
saveRDS(obj = species_vulnerabilities_normalized, file = paste(marine_bird_species_dir, "species_vulnerabilities_normalized.rds", sep = "/"))
