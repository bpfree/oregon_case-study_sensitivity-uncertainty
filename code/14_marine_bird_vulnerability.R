#####################################################
### 14. Marine bird species vulnerability indexes ###
#####################################################

# Clear environment
rm(list = ls())

# Load packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr,
               fasterize,
               fs,
               ggplot2,
               plyr,
               raster,
               rgdal,
               rgeos,
               rmapshaper,
               rnaturalearth, # use devtools::install_github("ropenscilabs/rnaturalearth") if packages does not install properly
               sf,
               sp,
               terra, # is replacing the raster package
               tidyr)

#####################################
#####################################

# Set directories
## Define data directory (as this is an R Project, pathnames are simplified)
### Input directories
data_dir <- "data/a_raw_data"
intermediate_dir <- "data/b_intermediate_data"

pop_dir <- "data/a_raw_data/Populationvulne"
col_dir <- "data/a_raw_data/Collisionvulner"
dis_dir <- "data/a_raw_data/Displacementvul"

### Output directories
#### Marine bird species directory
dir.create(paste0(intermediate_dir, "/",
                  "marine_bird_species"))

marine_bird_species_dir <- "data/b_intermediate_data/marine_bird_species"

#####################################
#####################################

vulnerability_function <- function(pdf, pages){
  
  # create vulnerability table from PDF
  vulnerability_table <- tabulizer::extract_tables(pdf,
                                                   # page tables are found (235) -- Table 3
                                                   pages = pages,
                                                   output = "data.frame")[[1]] %>%
    # delete the first two rows as they do not contain relevant information
    dplyr::filter(!row_number() %in% c(1,2)) %>%
    
    # split out population vulnerability to be three columns for the lower, best estimate, and upper after the ")" at the end of the rank
    tidyr::separate(Population.Vulnerability, into = c("pv_lower", "pv_be", "pv_upper"), sep = "\\) ", remove = T, convert = T) %>%
    # split the best estimate for the population vulnerability by getting values before the ")" designating rank
    tidyr::separate(pv_lower, into = c("pv_lower_value", "pv_lower_rank"), sep = " \\(", remove = T, convert = T) %>%
    # split the best estimate for the population vulnerability by getting values before the ")" designating rank
    tidyr::separate(pv_be, into = c("pv_be_value", "pv_be_rank"), sep = " \\(", remove = T, convert = T) %>%
    # split the best estimate for the population vulnerability by getting values before the ")" designating rank
    tidyr::separate(pv_upper, into = c("pv_upper_value", "pv_upper_rank"), sep = " \\(", remove = T, convert = T) %>%
    
    # split out collision vulnerability to be three columns for the lower, best estimate, and upper after the ")" at the end of the rank
    tidyr::separate(Collision.Vulnerability, into = c("cv_lower", "cv_be"), sep = "\\) ", remove = T, convert = T) %>%
    # split the lower for the collision vulnerability by getting values before the ")" designating rank
    tidyr::separate(cv_lower, into = c("cv_lower_value", "cv_lower_rank"), sep = " \\(", remove = T, convert = T) %>%
    # split the best estimate for the collision vulnerability by getting values before the ")" designating rank
    tidyr::separate(cv_be, into = c("cv_be_value", "cv_be_rank"), sep = " \\(", remove = T, convert = T) %>%
    # split the lower for the collision vulnerability by getting values before the ")" designating rank
    tidyr::separate(X.1, into = c("cv_upper_value", "cv_upper_rank"), sep = " \\(", remove = T, convert = T) %>%
    
    # split out displacement vulnerability to be three columns for the lower, best estimate, and upper after the ")" at the end of the rank
    tidyr::separate(Displacement.Vulnerability, into = c("dv_lower", "dv_be", "dv_upper"), sep = "\\) ", remove=T, convert = T) %>%
    # split the lower for the displacement vulnerability by getting values before the ")" designating rank
    tidyr::separate(dv_lower, into = c("dv_lower_value", "dv_lower_rank"), sep = " \\(", remove = T, convert = T) %>%
    # split the best estimate for the displacement vulnerability by getting values before the ")" designating rank
    tidyr::separate(dv_be, into = c("dv_be_value", "dv_be_rank"), sep = " \\(", remove = T, convert = T) %>%
    # split the upper for the displacement vulnerability by getting values before the ")" designating rank
    tidyr::separate(dv_upper, into = c("dv_upper_value", "dv_upper_rank"), sep = " \\(", remove = T, convert = T) %>%
    
    # rename fields to designate their association with vulnerability rank position
    dplyr::rename(pv_rank = X,
                  cv_rank = X.2,
                  dv_rank = X.3) %>%
    
    # select and order fields
    dplyr::select(Alpha.code,
                  Species,
                  pv_lower_value,
                  pv_be_value,
                  pv_upper_value,
                  pv_rank,
                  cv_lower_value,
                  cv_be_value,
                  cv_upper_value,
                  cv_rank,
                  dv_lower_value,
                  dv_be_value,
                  dv_upper_value,
                  dv_rank) %>%
    
    # rename the alpha code to designate it as a code for species
    dplyr::rename(species_code = Alpha.code,
                  species_name = Species) %>%
    
    # remove any rows with NA values
    na.omit()
  
  return(vulnerability_table)
}

#####################################

population_vulnerability_function <- function(pdf, pages){
  
  pop_vulnerability_table <- tabulizer::extract_tables(pdf,
                                                   # page tables are found (241 - 243) -- Appendix Table 2
                                                   pages = pages,
                                                   output = "data.frame")[[1]] %>%
    
    # delete the first two rows as they do not contain relevant information
    dplyr::filter(!row_number() %in% c(1)) %>%
    
    # spearate population vulnerability into lower, best estimate, and upper values
    tidyr::separate(Population.Vulnerability, into = c("pv_lower_value", "pv_be_value", "pv_upper_value"), sep = " ", remove = T, convert = T) %>%
    
    # rename fields
    dplyr::rename(species_name = Species.name..English.,
                  # uncertainty for global population (POP)
                  pop_uncertain = u,
                  # uncertainty for percent of population in the Pacific Outer Continental Shelf (POCSpop)
                  pocs_pop_uncertain = u.1,
                  # uncertainty for adult survival (AS)
                  as_uncertain = u.2,
                  # percent of best value
                  percent = X)
  
  return(pop_vulnerability_table)
}

#####################################

displacement_vulnerability_function <- function(pdf, pages){
  
  dis_vulnerability_table <- tabulizer::extract_tables(pdf,
                                                       # page tables are found (245 - 246) -- Appendix Table 4
                                                       pages = pages,
                                                       output = "data.frame")[[1]] %>%
    
    # delete the first two rows as they do not contain relevant information
    dplyr::filter(!row_number() %in% c(1)) %>%
    
    # spearate population vulnerability into lower, best estimate, and upper values
    tidyr::separate(Displacement.Vulnerability, into = c("dv_lower_value", "dv_be_value"), sep = " ", remove = T, convert = T) %>%
    
    # rename fields
    dplyr::rename(species_name = Species.name..English.,
                  # uncertainty for macro-avoidance (MAd)
                  mad_uncertain = u,
                  # uncertainty for habitat flexibility (HF)
                  hf_uncertain = u.1,
                  # displacement upper value
                  dis_upper_value = X,
                  # percent of best value
                  be_percent = X.1)
  
  return(dis_vulnerability_table)
}

#####################################
#####################################

# load data
## Adams et al. (2017) (paper: https://pubs.er.usgs.gov/publication/ofr20161154)
### Population vulnerability (source: https://www.sciencebase.gov/catalog/item/592f05a2e4b0e9bd0ea793df)
pv_csv <- read.csv(file = paste(pop_dir, "CCS_vulnerability_FINAL_VERSION_v9_PV.csv", sep = "/"))

### Collision vulnerability (source: https://www.sciencebase.gov/catalog/item/58f80528e4b0b7ea5451fcaf)
cv_csv <- read.csv(file = paste(col_dir, "CCS_vulnerability_FINAL_VERSION_v10_CV.csv", sep = "/"))

### Displacement vulnerability (source: https://www.sciencebase.gov/catalog/item/592efde1e4b0e9bd0ea7939c)
dv_csv <- read.csv(file = paste(dis_dir, "CCS_vulnerability_FINAL_VERSION_v10_DV.csv", sep = "/"))

## Kelsey et al. (2018) (source: https://www.sciencedirect.com/science/article/abs/pii/S0301479718309228)
pdf <- paste(data_dir, "kelsey_etal_2018.pdf", sep = "/")

#####################################
#####################################

# Create vulnerability tables
## Kelsey et al. (2018)
### First part of Table 3 (page 7, or page 235 of Kelsey et al. 2018)
vulnerability_table1 <- vulnerability_function(pdf, 7) %>%
  # recode species names for ones that are spread across two rows
  dplyr::mutate(species_name = recode(species_name,
                                      "Red-breasted" = "Red-breasted Merganser",
                                      "White-winged" = "White-winged Scoter",
                                      "Black-footed" = "Black-footed Albatross",
                                      "Pink-footed" = "Pink-footed Shearwater",
                                      "Flesh-footed" = "Flesh-footed Shearwater",
                                      "Black-vented" = "Black-vented Shearwater",
                                      "Wilson's Storm-" = "Wilson's Storm-Petrel",
                                      "Fork-tailed Storm-" = "Fork-tailed Storm-Petrel",
                                      "Double-crested" = "Double-crested Cormorant",
                                      "American White" = "American White Pelican",
                                      "Red-necked" = "Red-necked Phalarope")) %>%
  # change contents for two cells that have the same start of the common name
  ## see short-tailed Albatross (STAL) and short-tailed shearwater (SRTS)
  dplyr::mutate(species_name = ifelse(species_code == "STAL", "Short-tailed Albatross", species_name)) %>%
  dplyr::mutate(species_name = ifelse(species_code == "SRTS", "Short-tailed Shearwater", species_name))

### Second part of Table 3 (page 8, or page 236 of Kelsey et al. 2018)
vulnerability_table2 <- vulnerability_function(pdf, 8) %>%
  # recode species names for ones that are spread across two rows
  dplyr::mutate(species_name = recode(species_name,
                                      "Black-legged" = "Black-legged Kittiwake",
                                      "Glaucous-winged" = "Glaucous-winged Gull"))

### Create full vulnerability tables
vulnerability_table <- vulnerability_table1 %>%
  rbind(vulnerability_table2)

#####################################

# Create vulnerability metric tables
## Adams et al. (2017)
### Population vulnerability table (Table 4 -- page 12-13 of report / page 20-21 of PDF)
pv_table <- pv_csv %>%
  dplyr::select(Common_Name,
                AlphaCode,
                POP_Score,
                POP_Uncertainty_Value,
                AO_Score,
                CCSpop_Score,
                CCSpop_Uncertainty_Value,
                TS_Score,
                BR_Score,
                AS_Score,
                AS_Uncertainty_value,
                PV_Lower,
                PV_Best_Estimate,
                PV_Upper) %>%
  dplyr::rename(species_name = Common_Name,
                species_code = AlphaCode,
                pop = POP_Score,
                pop_uncertain = POP_Uncertainty_Value,
                ao = AO_Score,
                pocs_pop = CCSpop_Score,
                pocs_pop_uncertain = CCSpop_Uncertainty_Value,
                ts = TS_Score,
                br = BR_Score,
                as = AS_Score,
                as_uncertain = AS_Uncertainty_value,
                pv_lower = PV_Lower,
                pv_best_estimate = PV_Best_Estimate,
                pv_upper = PV_Upper) %>%
  # calculate minimum and maximum values for each metric
  ## ***Note: metric scores are kept within a 1 - 5 value range. Thus if a minimum after removing
  ##          uncertainty were less than one the floor is 1; in contrast the ceiling for the
  ##          maximum value (after adding the uncertainty) is 5
  dplyr::mutate(pop_min = ifelse(pop - pop_uncertain < 1, 1, pop - pop_uncertain),
                pop_max = ifelse(pop + pop_uncertain > 5, 5, pop + pop_uncertain),
                pocs_min = ifelse(pocs_pop - pocs_pop_uncertain < 1, 1, pocs_pop - pocs_pop_uncertain),
                pocs_max = ifelse(pocs_pop + pocs_pop_uncertain > 5, 5, pocs_pop + pocs_pop_uncertain),
                as_min = ifelse(as - as_uncertain < 1, 1, as - as_uncertain),
                as_max = ifelse(as + as_uncertain > 5, 5, as + as_uncertain)) %>%
  # recreate population vulnerability indexes
  dplyr::mutate(pv_lower_value = (pop_min) + (ao * (pocs_min)) + ts + (br * (as_min)),
                pv_be_value = (pop) + (ao * pocs_pop) + ts + (br * as),
                pv_upper_value = (pop_max) + (ao * (pocs_max)) + ts + (br * (as_max))) %>%
  # ***TEMPORARY: verification that values are the same
  dplyr::mutate(pv_lower_verification = pv_lower_value - pv_lower,
                pv_be_verification = pv_be_value - pv_best_estimate,
                pv_upper_verification = pv_upper_value - pv_upper)
  
### Collision vulnerability table (Table 5 -- page 24-26 of report / page 32-34 of PDF)
cv_table <- cv_csv %>%
  # select fields
  dplyr::select(Common_Name,
                AlphaCode,
                NFA_Score,
                NFA_Uncertainty_Value,
                DFA_Score,
                DFA_Uncertainty_Value,
                RSZt_Score,
                RSZt_Uncertainty_Value,
                MA_Collision_Score,
                MA_Uncertainty_Value,
                CV_Lower,
                CV_Best_Estimate,
                CV_Upper) %>%
  # rename fields
  dplyr::rename(species_name = Common_Name,
                species_code = AlphaCode,
                nfa = NFA_Score,
                nfa_uncertain = NFA_Uncertainty_Value,
                dfa = DFA_Score,
                dfa_uncertain = DFA_Uncertainty_Value,
                rszt = RSZt_Score,
                rszt_uncertain = RSZt_Uncertainty_Value,
                ma = MA_Collision_Score,
                ma_uncertain = MA_Uncertainty_Value,
                cv_lower = CV_Lower,
                cv_best_estimate = CV_Best_Estimate,
                cv_upper = CV_Upper) %>%
  # calculate minimum and maximum values for each metric
  ## ***Note: metric scores are kept within a 1 - 5 value range. Thus if a minimum after removing
  ##          uncertainty were less than one the floor is 1; in contrast the ceiling for the
  ##          maximum value (after adding the uncertainty) is 5
  dplyr::mutate(nfa_min = ifelse(nfa - nfa_uncertain < 1, 1, nfa - nfa_uncertain),
                nfa_max = ifelse(nfa + nfa_uncertain > 5, 5, nfa + nfa_uncertain),
                dfa_min = ifelse(dfa - dfa_uncertain < 1, 1, dfa - dfa_uncertain),
                dfa_max = ifelse(dfa + dfa_uncertain > 5, 5, dfa + dfa_uncertain),
                rszt_min = ifelse(rszt - rszt_uncertain < 1, 1, rszt - rszt_uncertain),
                rszt_max = ifelse(rszt + rszt_uncertain > 5, 5, rszt + rszt_uncertain),
                ma_min = ifelse(ma - ma_uncertain < 1, 1, ma - ma_uncertain),
                ma_max = ifelse(ma + ma_uncertain > 5, 5, ma + ma_uncertain)) %>%
  # recreate population vulnerability indexes
  dplyr::mutate(cv_lower_value = (((nfa_min) + (dfa_min)) / 2) + (rszt_min) + (ma_min),
                cv_be_value = (((nfa) + (dfa))/ 2) + (rszt) + (ma),
                cv_upper_value = (((nfa_max) + (dfa_max)) / 2) + (rszt_max) + (ma_max)) %>%
  # ***TEMPORARY: verification that values are the same
  dplyr::mutate(cv_lower_verification = cv_lower_value - cv_lower,
                cv_be_verification = cv_be_value - cv_best_estimate,
                cv_upper_verification = cv_upper_value - cv_upper)

### Displacement vulnerability table (Table 6 -- page 29-30 of report / page 37-38 of PDF)
dv_table <- dv_csv %>%
  # select fields
  dplyr::select(Common_Name,
                AlphaCode,
                MA_Score_Displacement,
                MA_Uncertainty_Value,
                HF_Score,
                HF_Uncertainty_Value,
                DV_Lower,
                DV_Best_Estimate,
                DV_Upper) %>%
  # rename fields
  dplyr::rename(species_name = Common_Name,
                species_code = AlphaCode,
                ma = MA_Score_Displacement,
                ma_uncertain = MA_Uncertainty_Value,
                hf = HF_Score,
                hf_uncertain = HF_Uncertainty_Value,
                dv_lower = DV_Lower,
                dv_best_estimate = DV_Best_Estimate,
                dv_upper = DV_Upper) %>%
  # calculate minimum and maximum values for each metric
  ## ***Note: metric scores are kept within a 1 - 5 value range. Thus if a minimum after removing
  ##          uncertainty were less than one the floor is 1; in contrast the ceiling for the
  ##          maximum value (after adding the uncertainty) is 5
  dplyr::mutate(ma_min = ifelse(ma - ma_uncertain < 1, 1, ma - ma_uncertain),
                ma_max = ifelse(ma + ma_uncertain > 5, 5, ma + ma_uncertain),
                hf_min = ifelse(hf - hf_uncertain < 1, 1, hf - hf_uncertain),
                hf_max = ifelse(hf + hf_uncertain > 5, 5, hf + hf_uncertain)) %>%
  # recreate population vulnerability indexes
  dplyr::mutate(dv_lower_value = ma_min + hf_min,
                dv_be_value = ma + hf,
                dv_upper_value = ma_max + hf_max) %>%
  # ***TEMPORARY: verification that values are the same
  dplyr::mutate(dv_lower_verification = dv_lower_value - dv_lower,
                dv_be_verification = dv_be_value - dv_best_estimate,
                dv_upper_verification = dv_upper_value - dv_upper)

#####################################

## Kelsey et al. (2018)
### Population vulnerability table
population_vulnerability_table <- population_vulnerability_function(pdf, 13) %>%
  rbind(population_vulnerability_function(pdf, 14),
        population_vulnerability_function(pdf, 15)) %>%
  dplyr::left_join(x = .,
                   y = vulnerability_table,
                   by = "species_name") %>%
  dplyr::select(-pv_lower_value.y,
                -pv_be_value.y,
                -pv_upper_value.y,
                -cv_lower_value,
                -cv_be_value,
                -cv_upper_value,
                -cv_rank,
                -dv_lower_value,
                -dv_be_value,
                -dv_upper_value,
                -dv_rank) %>%
  dplyr::rename(pv_lower_value = pv_lower_value.x,
                pv_be_value = pv_be_value.x,
                pv_upper_value = pv_upper_value.x) %>%
  dplyr::relocate(species_code, .before = species_name) %>%
  # recreate population vulnerability indexes (***WARNING: there are errors for certain species)
  dplyr::mutate(pop_vul_min = (POP - pop_uncertain) + (AO * (POCS.pop - pocs_pop_uncertain)) + TS + (BR * (AS - as_uncertain)),
                pop_vul_be = (POP) + (AO * POCS.pop) + TS + (BR * AS),
                pop_vul_max = (POP + pop_uncertain) + (AO * (POCS.pop + pocs_pop_uncertain)) + TS + (BR * (AS + as_uncertain)))


#####################################

## Collision vulnerability table
### First part of Appendix Table 3 (page 15, or page 243 of Kelsey et al. 2018)
col_vulnerability_table1 <- tabulizer::extract_tables(pdf,
                                                      # page tables are found (243 - 244) -- Appendix Table 3
                                                      pages = 15,
                                                      # it is the 2nd table on the 15th page
                                                      output = "data.frame")[[2]] %>%
  
  # delete the first two rows as they do not contain relevant information
  dplyr::filter(!row_number() %in% c(1)) %>%
  
  # spearate population vulnerability into lower, best estimate, and upper values
  tidyr::separate(Average.Flight.Activity, into = c("avg_flgt_act_lower_value", "avg_flgt_act_be_value", "avg_flgt_act_upper_value"), sep = " ", remove = T, convert = T) %>%
  tidyr::separate(Collision.Vulnerability, into = c("cv_lower_value", "cv_be_value", "cv_upper_value"), sep = " ", remove = T, convert = T) %>%
  
  # ***Note: see methods from Kelsey et al. (2018) to see more detail on average flight activity (average of nocturnal flight activity (NFA) and diurnal flight activity (DFA))
  
  # rename fields
  dplyr::rename(species_name = Species.name,
                # uncertainty for percent time spent in rotor sweep zone
                rszt_uncertain = u,
                # uncertainty for macro-avoidance
                mac_uncertain = u.1,
                # percent of best values
                percent = X)

### Second part of Appendix Table 3 (page 16, or page 243 of Kelsey et al. 2018)
col_vulnerability_table2 <- tabulizer::extract_tables(pdf,
                                                      # page tables are found (243 - 244) -- Appendix Table 3
                                                      pages = 16,
                                                      # it is the 1st table on the 16th page
                                                      output = "data.frame")[[1]] %>%
  
  # delete the first two rows as they do not contain relevant information
  dplyr::filter(!row_number() %in% c(1)) %>%
  
  # spearate population vulnerability into lower, best estimate, and upper values
  tidyr::separate(Average.Flight.Activity, into = c("avg_flgt_act_lower_value", "avg_flgt_act_be_value", "avg_flgt_act_upper_value"), sep = " ", remove = T, convert = T) %>%
  tidyr::separate(Collision.Vulnerability, into = c("cv_lower_value", "cv_be_value", "cv_upper_value"), sep = " ", remove = T, convert = T) %>%
  
  # ***Note: see methods from Kelsey et al. (2018) to see more detail on average flight activity (average of nocturnal flight activity (NFA) and diurnal flight activity (DFA))
  
  # rename fields
  dplyr::rename(species_name = Species.name,
                # uncertainty for percent time spent in rotor sweep zone
                rszt_uncertain = u,
                # uncertainty for macro-avoidance
                mac_uncertain = u.1,
                # percent of best values
                percent = X)

collision_vulnerability_table <- col_vulnerability_table1 %>%
  rbind(col_vulnerability_table2) %>%
  dplyr::left_join(x = .,
                   y = vulnerability_table,
                   by = "species_name") %>%
  dplyr::select(-pv_lower_value,
                -pv_be_value,
                -pv_upper_value,
                -pv_rank,
                -cv_lower_value.y,
                -cv_be_value.y,
                -cv_upper_value.y,
                -dv_lower_value,
                -dv_be_value,
                -dv_upper_value,
                -dv_rank) %>%
  dplyr::rename(cv_lower_value = cv_lower_value.x,
                cv_be_value = cv_be_value.x,
                cv_upper_value = cv_upper_value.x) %>%
  dplyr::relocate(species_code, .before = species_name) %>%
  # recreate collision vulnerability index (WARNING: not possible to score as calculations for nocturnal nor diurnal flight
  # activities are available)
  dplyr::mutate(col_vul_index_lower = )

#####################################

## Displacement vulnerability table
displacement_vulnerability_table <- displacement_vulnerability_function(pdf, 17) %>%
  rbind(displacement_vulnerability_function(pdf, 18)) %>%
  dplyr::left_join(x = .,
                   y = vulnerability_table,
                   by = "species_name") %>%
  dplyr::select(-pv_lower_value,
                -pv_be_value,
                -pv_upper_value,
                -pv_rank,
                -cv_lower_value,
                -cv_be_value,
                -cv_upper_value,
                -cv_rank,
                -dv_lower_value.y,
                -dv_be_value.y,
                -dv_upper_value.y) %>%
  dplyr::rename(dv_lower_value = dv_lower_value.x,
                dv_be_value = dv_be_value.x,
                dv_upper_value = dv_upper_value.x) %>%
  dplyr::relocate(species_code, .before = species_name)

#####################################
#####################################

# Export data
## Marine bird species directory
### Overall vulnerability table
saveRDS(obj = vulnerability_table, file = paste(marine_bird_species_dir, "marine_bird_species_vulnerability.rds", sep = "/"))

### Metric specific vulnerability table
saveRDS(obj = population_vulnerability_table, file = paste(marine_bird_species_dir, "marine_bird_species_population_vulnerability.rds", sep = "/"))
saveRDS(obj = collision_vulnerability_table, file = paste(marine_bird_species_dir, "marine_bird_species_collision_vulnerability.rds", sep = "/"))
saveRDS(obj = displacement_vulnerability_table, file = paste(marine_bird_species_dir, "marine_bird_species_displacement_vulnerability.rds", sep = "/"))
